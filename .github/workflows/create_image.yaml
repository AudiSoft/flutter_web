# Copyright Â© 2021 - AudiSoft Consulting (https://www.audisoft.com/).

# Creates an Ubuntu-based Docker image with web-enabled Flutter already installed.
name: Create Flutter Web Docker Image

# Run this workflow every time a new commit is pushed.
on: push

jobs:
  create_image:
    name: Create image
    runs-on: ubuntu-latest
    steps:
      # Checkout the code base.
      - name: 1 - Checkout
        uses: actions/checkout@v2
      # Test secret
      - name: 0 - Test secret
        run: echo $GITHUB_ACTOR
      - run: echo ${{ secrets.CONTAINER_REGISTRY_TOKEN }}
      - run: echo $GITHUB_ACTOR
      # Login with new container registry url and PAT.
      - name: 1 - Login
        run: echo ${{ secrets.CONTAINER_REGISTRY_TOKEN }} | docker login ghcr.io -u $GITHUB_ACTOR --password-stdin
      # Build container image.
      - name: 2 - Build image
        run: docker pull cirrusci/flutter:latest
      - run: docker build . --tag ghcr.io/github/flutter:$GITHUB_SHA --cache-from ghcr.io/github/flutter:latest
      - run: docker push ghcr.io/github/flutter:$GITHUB_SHA
